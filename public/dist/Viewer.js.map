{"version":3,"file":"Viewer.js","sources":["../../src/Viewer.js"],"sourcesContent":["// SPDX-FileCopyrightText: Â© 2021 Tech and Software Ltd.\n// SPDX-License-Identifier: AGPL-3.0-only OR LicenseRef-uk.ltd.TechAndSoftware-1.0\n\nconst FONTS = ['sans-serif', 'Bedstead', 'native', 'serif', 'Unscii', 'monospace', 'cursive'];\nconst VIEWS = ['classic__graphic-for-mosaic', 'classic__font-for-mosaic'];\n\nimport { Teletext, Level } from '@techandsoftware/teletext';\n\nexport class App {\n    constructor() {\n        this._ttx = Teletext();\n        this._ttx.setDefaultG0Charset('g0_latin__english');\n        this._ttx.setLevel(Level[1.5]);\n        this._ttx.addTo('#teletextscreen');\n        this._ttx.setHeight(500);\n        this._ttx.showTestPage();\n\n        this._fontIndex = 0;\n        this._viewIndex = 0;\n        this._smoothPluginIsLoaded = false;\n\n        this._pageNumber = \"100\";\n        this._magazine = null;\n        this._magazineData = null;\n\n        this._initEventListeners();\n    }\n\n    _initEventListeners() {\n        window.addEventListener('keypress', e => handleKeyPress.call(this, e));\n\n        window.addEventListener('DOMContentLoaded', () => {\n            document.querySelector('#revealButton').addEventListener('click', () => {\n                window.dispatchEvent(new Event('ttx.reveal'));\n            });\n            document.querySelector('#mixButton').addEventListener('click', () => {\n                window.dispatchEvent(new Event('ttx.mix'));\n            });\n            document.querySelector('#pageNumber').addEventListener('change', e => {\n                if (e.target.value.length == 3) this._newPage();\n            });\n        });\n    }\n\n    _numberInput(number) {\n        const pnLength = String(this._pageNumber).length;\n        if (pnLength == 3) {\n            this._pageNumber = number;\n        } else {\n            this._pageNumber = String(this._pageNumber) + number;\n        }\n        this._updatePageNumber();\n        if (String(this._pageNumber).length == 3) this._newPage();\n    }\n\n    _updatePageNumber() {\n        document.querySelector('#pageNumber').value = this._pageNumber;\n    }\n\n    _newPage() {\n        const matches = this._pageNumber.match(/([12345678])\\d\\d/);\n        if (matches != null) {\n            const magazine = matches[1];\n            this._showPage(magazine);\n        }\n    }\n\n    async _showPage(magazine) {\n        console.info('showing page in mag', magazine, this._pageNumber);\n        if (this._magazine != magazine) {\n            try {\n                const res = await fetch(`${magazine}.json`);\n                this._magazineData = await res.json();\n                this._magazine = magazine;\n            } catch (e) {\n                console.warn(`e75 _showPage: failed to load magazine data from ${magazine}.json :`, e.message);\n            }\n        }\n        if (this._magazine == magazine && this._pageNumber in this._magazineData.pages) {\n            const outputLines = this._getFirstSubPage();\n            if (outputLines != null) {\n                this._ttx.clearScreen();\n                this._ttx.setPageFromOutputLines(outputLines);\n            }\n        } else {\n            console.info('No page', this._pageNumber);\n        }\n    }\n\n    _getFirstSubPage() {\n        for (const subpage of [...this._magazineData.pages[this._pageNumber].subpages]) {\n            if (subpage != null) return subpage.outputLines.split(\"\\n\");\n        }\n        return null;\n    }\n}\n\nasync function handleKeyPress(e) {\n    switch (e.key) {\n        case '1':\n        case '2':\n        case '3':\n        case '4':\n        case '5':\n        case '6':\n        case '7':\n        case '8':\n        case '9':\n        case '0':\n            if (!(document.querySelector('#pageNumber') == document.activeElement))\n                this._numberInput(e.key);\n            break;\n\n        case '?': // reveal\n            window.dispatchEvent(new Event(\"ttx.reveal\"));\n            break;\n\n        case 'm': // mix\n            window.dispatchEvent(new Event(\"ttx.mix\"));\n            break;\n\n        case 'f': // rotate through fonts\n            this._fontIndex++;\n            if (this._fontIndex == FONTS.length) this._fontIndex = 0;\n            console.debug('setting font to', FONTS[this._fontIndex]);\n            this._ttx.setFont(FONTS[this._fontIndex]);\n            break;\n\n        case 'w': // for wipe\n            this._ttx.clearScreen();\n            break;\n\n        case 'h':\n            this._ttx.setHeight(document.documentElement.clientHeight * 0.8);\n            break;\n\n        case 'v': // switch views which changes the mosaic rendering method\n            this._viewIndex++;\n            if (this._viewIndex == VIEWS.length) this._viewIndex = 0;\n            this._ttx.setView(VIEWS[this._viewIndex]);\n            this._smoothPluginIsLoaded = false;\n            break;\n\n        case 'p': // load or remove the plugin to smooth mosaic graphics\n            if (this._smoothPluginIsLoaded) {\n                this._ttx.setView(VIEWS[this._viewIndex]); // resetting the view removes the plugin\n                this._smoothPluginIsLoaded = false;\n            } else if (this._viewIndex == 0) {  // plugin works on the graphical mosaic view\n                // Loading the plugin as a dynamic import as it's large\n                // This also avoids having to bundle it with the application lib at build time\n                try {\n                    const module = await import('@techandsoftware/teletext-plugin-smooth-mosaic');\n                    this._ttx.registerViewPlugin(module.SmoothMosaicPlugin);\n                    this._smoothPluginIsLoaded = true;\n                } catch (e) {\n                    console.error('App: Failed to use smooth mosaic plugin: import failed:', e.message);\n                }\n            }\n            break;\n\n        default:\n    }\n}\n"],"names":[],"mappings":";;AAAA;AACA;AACA;AACA,MAAM,KAAK,GAAG,CAAC,YAAY,EAAE,UAAU,EAAE,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE,WAAW,EAAE,SAAS,CAAC,CAAC;AAC9F,MAAM,KAAK,GAAG,CAAC,6BAA6B,EAAE,0BAA0B,CAAC,CAAC;AAG1E;AACO,MAAM,GAAG,CAAC;AACjB,IAAI,WAAW,GAAG;AAClB,QAAQ,IAAI,CAAC,IAAI,GAAG,QAAQ,EAAE,CAAC;AAC/B,QAAQ,IAAI,CAAC,IAAI,CAAC,mBAAmB,CAAC,mBAAmB,CAAC,CAAC;AAC3D,QAAQ,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC;AACvC,QAAQ,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAC;AAC3C,QAAQ,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC;AACjC,QAAQ,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC;AACjC;AACA,QAAQ,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;AAC5B,QAAQ,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;AAC5B,QAAQ,IAAI,CAAC,qBAAqB,GAAG,KAAK,CAAC;AAC3C;AACA,QAAQ,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;AACjC,QAAQ,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC;AAC9B,QAAQ,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC;AAClC;AACA,QAAQ,IAAI,CAAC,mBAAmB,EAAE,CAAC;AACnC,KAAK;AACL;AACA,IAAI,mBAAmB,GAAG;AAC1B,QAAQ,MAAM,CAAC,gBAAgB,CAAC,UAAU,EAAE,CAAC,IAAI,cAAc,CAAC,IAAI,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC,CAAC;AAC/E;AACA,QAAQ,MAAM,CAAC,gBAAgB,CAAC,kBAAkB,EAAE,MAAM;AAC1D,YAAY,QAAQ,CAAC,aAAa,CAAC,eAAe,CAAC,CAAC,gBAAgB,CAAC,OAAO,EAAE,MAAM;AACpF,gBAAgB,MAAM,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC,YAAY,CAAC,CAAC,CAAC;AAC9D,aAAa,CAAC,CAAC;AACf,YAAY,QAAQ,CAAC,aAAa,CAAC,YAAY,CAAC,CAAC,gBAAgB,CAAC,OAAO,EAAE,MAAM;AACjF,gBAAgB,MAAM,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC;AAC3D,aAAa,CAAC,CAAC;AACf,YAAY,QAAQ,CAAC,aAAa,CAAC,aAAa,CAAC,CAAC,gBAAgB,CAAC,QAAQ,EAAE,CAAC,IAAI;AAClF,gBAAgB,IAAI,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,MAAM,IAAI,CAAC,EAAE,IAAI,CAAC,QAAQ,EAAE,CAAC;AAChE,aAAa,CAAC,CAAC;AACf,SAAS,CAAC,CAAC;AACX,KAAK;AACL;AACA,IAAI,YAAY,CAAC,MAAM,EAAE;AACzB,QAAQ,MAAM,QAAQ,GAAG,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,MAAM,CAAC;AACzD,QAAQ,IAAI,QAAQ,IAAI,CAAC,EAAE;AAC3B,YAAY,IAAI,CAAC,WAAW,GAAG,MAAM,CAAC;AACtC,SAAS,MAAM;AACf,YAAY,IAAI,CAAC,WAAW,GAAG,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,GAAG,MAAM,CAAC;AACjE,SAAS;AACT,QAAQ,IAAI,CAAC,iBAAiB,EAAE,CAAC;AACjC,QAAQ,IAAI,MAAM,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,MAAM,IAAI,CAAC,EAAE,IAAI,CAAC,QAAQ,EAAE,CAAC;AAClE,KAAK;AACL;AACA,IAAI,iBAAiB,GAAG;AACxB,QAAQ,QAAQ,CAAC,aAAa,CAAC,aAAa,CAAC,CAAC,KAAK,GAAG,IAAI,CAAC,WAAW,CAAC;AACvE,KAAK;AACL;AACA,IAAI,QAAQ,GAAG;AACf,QAAQ,MAAM,OAAO,GAAG,IAAI,CAAC,WAAW,CAAC,KAAK,CAAC,kBAAkB,CAAC,CAAC;AACnE,QAAQ,IAAI,OAAO,IAAI,IAAI,EAAE;AAC7B,YAAY,MAAM,QAAQ,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;AACxC,YAAY,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,CAAC;AACrC,SAAS;AACT,KAAK;AACL;AACA,IAAI,MAAM,SAAS,CAAC,QAAQ,EAAE;AAC9B,QAAQ,OAAO,CAAC,IAAI,CAAC,qBAAqB,EAAE,QAAQ,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;AACxE,QAAQ,IAAI,IAAI,CAAC,SAAS,IAAI,QAAQ,EAAE;AACxC,YAAY,IAAI;AAChB,gBAAgB,MAAM,GAAG,GAAG,MAAM,KAAK,CAAC,CAAC,EAAE,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;AAC5D,gBAAgB,IAAI,CAAC,aAAa,GAAG,MAAM,GAAG,CAAC,IAAI,EAAE,CAAC;AACtD,gBAAgB,IAAI,CAAC,SAAS,GAAG,QAAQ,CAAC;AAC1C,aAAa,CAAC,OAAO,CAAC,EAAE;AACxB,gBAAgB,OAAO,CAAC,IAAI,CAAC,CAAC,iDAAiD,EAAE,QAAQ,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC;AAC/G,aAAa;AACb,SAAS;AACT,QAAQ,IAAI,IAAI,CAAC,SAAS,IAAI,QAAQ,IAAI,IAAI,CAAC,WAAW,IAAI,IAAI,CAAC,aAAa,CAAC,KAAK,EAAE;AACxF,YAAY,MAAM,WAAW,GAAG,IAAI,CAAC,gBAAgB,EAAE,CAAC;AACxD,YAAY,IAAI,WAAW,IAAI,IAAI,EAAE;AACrC,gBAAgB,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;AACxC,gBAAgB,IAAI,CAAC,IAAI,CAAC,sBAAsB,CAAC,WAAW,CAAC,CAAC;AAC9D,aAAa;AACb,SAAS,MAAM;AACf,YAAY,OAAO,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;AACtD,SAAS;AACT,KAAK;AACL;AACA,IAAI,gBAAgB,GAAG;AACvB,QAAQ,KAAK,MAAM,OAAO,IAAI,CAAC,GAAG,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,QAAQ,CAAC,EAAE;AACxF,YAAY,IAAI,OAAO,IAAI,IAAI,EAAE,OAAO,OAAO,CAAC,WAAW,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;AACxE,SAAS;AACT,QAAQ,OAAO,IAAI,CAAC;AACpB,KAAK;AACL,CAAC;AACD;AACA,eAAe,cAAc,CAAC,CAAC,EAAE;AACjC,IAAI,QAAQ,CAAC,CAAC,GAAG;AACjB,QAAQ,KAAK,GAAG,CAAC;AACjB,QAAQ,KAAK,GAAG,CAAC;AACjB,QAAQ,KAAK,GAAG,CAAC;AACjB,QAAQ,KAAK,GAAG,CAAC;AACjB,QAAQ,KAAK,GAAG,CAAC;AACjB,QAAQ,KAAK,GAAG,CAAC;AACjB,QAAQ,KAAK,GAAG,CAAC;AACjB,QAAQ,KAAK,GAAG,CAAC;AACjB,QAAQ,KAAK,GAAG,CAAC;AACjB,QAAQ,KAAK,GAAG;AAChB,YAAY,IAAI,EAAE,QAAQ,CAAC,aAAa,CAAC,aAAa,CAAC,IAAI,QAAQ,CAAC,aAAa,CAAC;AAClF,gBAAgB,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC;AACzC,YAAY,MAAM;AAClB;AACA,QAAQ,KAAK,GAAG;AAChB,YAAY,MAAM,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC,YAAY,CAAC,CAAC,CAAC;AAC1D,YAAY,MAAM;AAClB;AACA,QAAQ,KAAK,GAAG;AAChB,YAAY,MAAM,CAAC,aAAa,CAAC,IAAI,KAAK,CAAC,SAAS,CAAC,CAAC,CAAC;AACvD,YAAY,MAAM;AAClB;AACA,QAAQ,KAAK,GAAG;AAChB,YAAY,IAAI,CAAC,UAAU,EAAE,CAAC;AAC9B,YAAY,IAAI,IAAI,CAAC,UAAU,IAAI,KAAK,CAAC,MAAM,EAAE,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;AACrE,YAAY,OAAO,CAAC,KAAK,CAAC,iBAAiB,EAAE,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC;AACrE,YAAY,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC;AACtD,YAAY,MAAM;AAClB;AACA,QAAQ,KAAK,GAAG;AAChB,YAAY,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;AACpC,YAAY,MAAM;AAClB;AACA,QAAQ,KAAK,GAAG;AAChB,YAAY,IAAI,CAAC,IAAI,CAAC,SAAS,CAAC,QAAQ,CAAC,eAAe,CAAC,YAAY,GAAG,GAAG,CAAC,CAAC;AAC7E,YAAY,MAAM;AAClB;AACA,QAAQ,KAAK,GAAG;AAChB,YAAY,IAAI,CAAC,UAAU,EAAE,CAAC;AAC9B,YAAY,IAAI,IAAI,CAAC,UAAU,IAAI,KAAK,CAAC,MAAM,EAAE,IAAI,CAAC,UAAU,GAAG,CAAC,CAAC;AACrE,YAAY,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC;AACtD,YAAY,IAAI,CAAC,qBAAqB,GAAG,KAAK,CAAC;AAC/C,YAAY,MAAM;AAClB;AACA,QAAQ,KAAK,GAAG;AAChB,YAAY,IAAI,IAAI,CAAC,qBAAqB,EAAE;AAC5C,gBAAgB,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC;AAC1D,gBAAgB,IAAI,CAAC,qBAAqB,GAAG,KAAK,CAAC;AACnD,aAAa,MAAM,IAAI,IAAI,CAAC,UAAU,IAAI,CAAC,EAAE;AAC7C;AACA;AACA,gBAAgB,IAAI;AACpB,oBAAoB,MAAM,MAAM,GAAG,MAAM,OAAO,yHAAgD,CAAC,CAAC;AAClG,oBAAoB,IAAI,CAAC,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,kBAAkB,CAAC,CAAC;AAC5E,oBAAoB,IAAI,CAAC,qBAAqB,GAAG,IAAI,CAAC;AACtD,iBAAiB,CAAC,OAAO,CAAC,EAAE;AAC5B,oBAAoB,OAAO,CAAC,KAAK,CAAC,yDAAyD,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC;AACxG,iBAAiB;AACjB,aAAa;AACb,YAAY,MAAM;AAGlB,KAAK;AACL;;;;"}